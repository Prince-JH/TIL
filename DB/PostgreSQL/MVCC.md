# PostgreSQL MVCC

## MVCC의 기본 원칙
- 각 트랜잭션에게 데이터의 "버전"을 제공: 트랜잭션이 데이터를 수정할 때마다 해당 데이터의 새로운 "버전"이 생성된다. 다른 트랜잭션은 이전 버전의 데이터를 계속 볼 수 있다.

- 동시성 제공: 여러 트랜잭션들이 동시에 실행되어도 서로 간섭하지 않는다. 트랜잭션은 각자의 데이터 스냅샷을 바라보므로, 다른 트랜잭션에서의 변경이 즉시 보이지 않는다.

- 비 잠금 동시성: 대부분의 경우, 데이터를 읽기 위해 잠금을 획득할 필요가 없다. 이는 높은 동시성과 낮은 대기 시간을 제공한다.


## MVCC가 해결하는 문제

PostgreSQL은 기본적으로 Repeatable Read 격리 수준을 제공한다. 해당 격리 수준에서는 `Phantom Read`가 발생할 수 있는데, 해당 트랜잭션이 시작될 때의 데이터 스냅샷을 바탕으로 동작하는 MVCC 메커니즘으로 인해 phantom read를 방지할 수 있다.


## VACCUM 프로세스

MVCC의 특성 사 데이터가 수정될 때마다 새로운 버전의 데이터가 생성된다. 이로 인해 시간이 지남에 따라 **불필요한** 데이터 버전이 쌓이고, 이를 처리하기 위해 **VACUUM** 프로세스를 사용한다.

VACCUM 프로세스는 주로 두 가지 기능을 수행한다.
- 불필요한 튜플 정리: 사용되지 않는 오래된 데이터 버전 제거
- 공간 재활용: 삭제된 데이터로 인해 생긴 빈 공간을 데이터베이스 내에서 재활용

VACUUM에는 몇 가지 다른 모드가 있다.
- 일반 VACCUM: 불필요한 튜플을 정리하고, 공간을 재활용하여 다음에 데이터가 삽입될 때 사용할 수 있게한다. **그러나 파일 시스템으로 바로 반환되지는 않는다.**
- FULL VACCUM: 데이터베이스를 완전히 재구성하여 사용되지 않는 공간을 OS에 반환한다. 이 작업은 자원을 많이 사용하며, 동작 중에는 해당 테이블에 대한 잠금이 필요하다.
- AUTO VACCUM: autovacuum 데몬을 통해 자동으로 VACUUM 작업을 수행한다. 이 데몬은 설정에 따라 주기적으로 또는 특정 조건에서 VACUUM 작업을 자동으로 실행하여 데이터베이스 성능을 최적화할 수 있다.

VACCUM은 쿼리 계획과도 연관이 있는데, 일반 VACCUM이 일어날 때 업데이트된 인덱스와 테이블 통계를 바탕으로 쿼리 플래너가 최적화된 쿼리 계획을 만든다.